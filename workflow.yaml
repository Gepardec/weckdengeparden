apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  namespace: argo-workflows
  generateName: weck-den-geparden-
spec:
  serviceAccountName: argo
  entrypoint: cicd
  arguments:
    parameters:
    - name: repo
      value: https://github.com/Gepardec/weckdengeparden.git
    - name: revision
      value: feature/argo-workflows
  volumeClaimTemplates:
  - metadata:
      name: workspace
    spec:
      resources:
        requests:
          storage: 500M
      accessModes: ["ReadWriteOnce"]
  templates:
  - name: cicd
    steps:
      - - name: checkout
          template: checkout
      - - name: build-jar
          template: build-jar
      - - name: image-build-push
          template: image-build-push
          arguments:
            parameters:
            - name: tag
              value: "{{ steps.checkout.outputs.parameters.image-tag }}"
  - name: checkout
    metadata:
      labels:
        app: argo
    container:
      image: alpine/git
      name: git
      command: [sh, -c]
      args: ["cd /mnt/out/ && git clone {{ workflow.parameters.repo }} && cd weckdengeparden && git checkout {{ workflow.parameters.revision }} && git rev-parse --short HEAD > ./git-commit"]
      volumeMounts:
      - name: workspace
        mountPath: /mnt/out/
    outputs:
      parameters:
      - name: image-tag
        valueFrom:
          path: /mnt/out/weckdengeparden/git-commit
  - name: build-jar
    metadata:
      labels:
        app: argo
    container:
      image: "maven:3.8.4-jdk-11"
      command: [sh, -c]
      args: ["cd /mnt/out/weckdengeparden/ && mvn clean package -DskipTests"]
      volumeMounts:
      - name: workspace
        mountPath: /mnt/out/
  - name: image-build-push
    inputs:
      parameters:
      - name: tag
    metadata:
      labels:
        app: argo
    container:
      image: gcr.io/kaniko-project/executor:latest
      args:
        - --dockerfile=Containerfile
        - --context=/mnt/out/weckdengeparden
        - --destination=image-registry.openshift-image-registry.svc.cluster.local:5000/argo-workflows/wdg:{{inputs.parameters.tag}}
        - --skip-tls-verify
      volumeMounts:
      - name: workspace
        mountPath: /mnt/out/
      - name: dockerconfig
        mountPath: /kaniko/.docker
    volumes:
    - name: dockerconfig
      secret:
        secretName: argo-sa-dockercfg-2
        items:
        - key: .dockerconfigjson
          path: config.json
